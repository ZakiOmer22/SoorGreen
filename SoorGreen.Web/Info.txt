SoorGreen.Web/ ( ASP.NET MVC ) https://localhost:44305/ ( & "C:\Program Files\IIS Express\iisexpress.exe" /path:"Z:\ZAKI\Sem 1\Asp.net\MAIN\SoorGreen.Web" /port:44305 )
├── Controllers/
│   ├── HomeController.cs
│   ├── AccountController.cs
│   ├── WasteController.cs
│   ├── RewardsController.cs
│   ├── PickupController.cs
│   └── FeedbackController.cs
│
├── Models/
│   ├── ViewModels/
│   │   ├── WasteReportVM.cs
│   │   ├── PickupVM.cs
│   │   ├── RewardVM.cs
│   │   └── ProfileVM.cs
│   └── DTOs/
│       └── ApiResponse.cs
│
├── Views/
│   ├── Home/
│   │   ├── Index.cshtml
│   │   ├── About.cshtml
│   │   └── Contact.cshtml
│   ├── Account/
│   ├── Waste/
│   ├── Rewards/
│   ├── Pickup/
│   └── Shared/
│       ├── _Layout.cshtml
│       └── _Navbar.cshtml
│
├── wwwroot/
│   ├── css/
│   ├── js/
│   ├── images/
│   └── libs/
│
├── appsettings.json
├── Program.cs
└── Startup.cs


SoorGreen.Admin/ ( ASP.NET Web Forms ) https://localhost:44381/  ( & "C:\Program Files\IIS Express\iisexpress.exe" /path:"Z:\ZAKI\Sem 1\Asp.net\MAIN\SoorGreen.Admin" /port:44381 )
├── Pages/
│   ├── Dashboard.aspx
│   ├── Users.aspx
│   ├── Pickups.aspx
│   ├── WasteReports.aspx
│   ├── Rewards.aspx
│   ├── Reports.aspx
│   ├── Settings.aspx
│   └── Login.aspx
│
├── Controls/
│   ├── NavBar.ascx
│   ├── Sidebar.ascx
│   └── NotificationPanel.ascx
│
├── Scripts/
│   ├── charts.js
│   ├── datatables.js
│   └── notifications.js
│
├── Styles/
│   └── admin.css
│
├── Web.config
└── Global.asax

SoorGreen.CustomSolutionPlatform/ https://localhost:44306/  ( & "C:\Program Files\IIS Express\iisexpress.exe" /path:"Z:\ZAKI\Sem 1\Asp.net\MAIN\CustomSolutionPlatform" /port:44306 )
│
├── Default.aspx                 (Main landing page)
├── Questionnaire.aspx           (Dynamic questionnaire system)
├── Solutions.aspx               (Generated solutions display)
├── Templates/                   (Solution templates)
│   ├── IT/
│   ├── NonIT/
│   └── Hybrid/
├── Database/
│   ├── QuestionBank.xml         (Question repository)
│   └── SolutionTemplates.xml    (Solution templates)
├── Scripts/
│   ├── questionnaire.js         (Dynamic form logic)
│   └── solution-generator.js    (Solution creation)
├── Styles/
│   └── custom-platform.css      (Platform-specific styles)
└── Web.config                   (Project configuration)


-- ========================================
-- SoorGreenDB Setup Script
-- Project Codename: DIBUCELIN
-- Description: Smart sustainability app rewarding citizens 
-- for recycling and helping cities manage waste efficiently.
-- ========================================

-- 1. Create Database
CREATE DATABASE SoorGreenDB;
GO

USE SoorGreenDB;
GO

-- ========================================
-- 2. TABLES
-- ========================================

-- ROLES: Defines system access roles
CREATE TABLE Roles (
    RoleId CHAR(4) PRIMARY KEY,
    RoleName NVARCHAR(50) NOT NULL
);

-- USERS: Registered accounts (citizens, collectors, admins, companies)
CREATE TABLE Users (
    UserId CHAR(4) PRIMARY KEY,
    FullName NVARCHAR(150) NOT NULL,
    Phone NVARCHAR(20) UNIQUE NOT NULL,
    Email NVARCHAR(256),
	Password NVARCHAR(100) NULL,
    RoleId CHAR(4) NOT NULL,
    XP_Credits DECIMAL(10,2) DEFAULT 0,
    CreatedAt DATETIME DEFAULT GETDATE(),
    LastLogin DATETIME NULL,
    IsVerified BIT DEFAULT 0,
    CONSTRAINT FK_Users_Roles FOREIGN KEY(RoleId) REFERENCES Roles(RoleId)
);

-- MUNICIPALITIES: Defines city or zone
CREATE TABLE Municipalities (
    MunicipalityId CHAR(4) PRIMARY KEY,
    Name NVARCHAR(100) NOT NULL,
	Region NVARCHAR(100) NULL,
    Status NVARCHAR(20) DEFAULT 'Active',
    Population BIGINT DEFAULT 0,
    Area DECIMAL(10,2) DEFAULT 0,
    ContactPerson NVARCHAR(100) NULL,
    ContactNumber NVARCHAR(20) NULL,
    Email NVARCHAR(100) NULL,
    Address NVARCHAR(300) NULL,
    EstablishedDate DATETIME NULL,
    Description NVARCHAR(500) NULL
);

-- WASTE TYPES: Categories of waste
CREATE TABLE WasteTypes (
    WasteTypeId CHAR(4) PRIMARY KEY,
    Name NVARCHAR(50) NOT NULL,
	ColorCode NVARCHAR(7) NULL,
    Description NVARCHAR(500) NULL,
    Category NVARCHAR(50) DEFAULT 'Other',
    CreditPerKg DECIMAL(5,2) NOT NULL
);

-- WASTE REPORTS: Citizen submits report of waste to collect
CREATE TABLE WasteReports (
    ReportId CHAR(4) PRIMARY KEY,
    UserId CHAR(4) NOT NULL,
    WasteTypeId CHAR(4) NOT NULL,
    EstimatedKg DECIMAL(6,2) NOT NULL,
    Address NVARCHAR(300) NOT NULL,
    Lat DECIMAL(10,6),
    Lng DECIMAL(10,6),
    Landmark NVARCHAR(200) NULL,
    PhotoUrl NVARCHAR(512),
    CreatedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_WasteReports_Users FOREIGN KEY(UserId) REFERENCES Users(UserId),
    CONSTRAINT FK_WasteReports_WasteTypes FOREIGN KEY(WasteTypeId) REFERENCES WasteTypes(WasteTypeId)
);

-- PICKUP REQUESTS: Links collectors to reports
CREATE TABLE PickupRequests (
    PickupId CHAR(4) PRIMARY KEY,
    ReportId CHAR(4) NOT NULL,
    CollectorId CHAR(4) NULL,
    Status NVARCHAR(20) DEFAULT 'Requested',
    ScheduledAt DATETIME NULL,
    CompletedAt DATETIME NULL,
    CONSTRAINT FK_PickupRequests_Reports FOREIGN KEY(ReportId) REFERENCES WasteReports(ReportId),
    CONSTRAINT FK_PickupRequests_Collector FOREIGN KEY(CollectorId) REFERENCES Users(UserId)
);

-- REWARD POINTS: XP/credit transactions for users
CREATE TABLE RewardPoints (
    RewardId CHAR(4) PRIMARY KEY,
    UserId CHAR(4) NOT NULL,
    Amount DECIMAL(10,2) NOT NULL,
    Type NVARCHAR(50),
    Reference NVARCHAR(100),
    CreatedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_RewardPoints_User FOREIGN KEY(UserId) REFERENCES Users(UserId)
);

-- REDEMPTION REQUESTS: Users cash out credits
CREATE TABLE RedemptionRequests (
    RedemptionId CHAR(4) PRIMARY KEY,
    UserId CHAR(4) NOT NULL,
    Amount DECIMAL(10,2) NOT NULL,
    Method NVARCHAR(50),
    Status NVARCHAR(20) DEFAULT 'Pending',
    RequestedAt DATETIME DEFAULT GETDATE(),
    ProcessedAt DATETIME NULL,
    CONSTRAINT FK_RedemptionRequests_User FOREIGN KEY(UserId) REFERENCES Users(UserId)
);

-- NOTIFICATIONS: User alerts
CREATE TABLE Notifications (
    NotificationId CHAR(4) PRIMARY KEY,
    UserId CHAR(4) NOT NULL,
    Title NVARCHAR(200),
    Message NVARCHAR(1000),
    IsRead BIT DEFAULT 0,
    CreatedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_Notifications_User FOREIGN KEY(UserId) REFERENCES Users(UserId)
);

-- AUDIT LOGS: Logs key system actions
CREATE TABLE AuditLogs (
    AuditId CHAR(4) PRIMARY KEY,
    UserId CHAR(4) NULL,
    Action NVARCHAR(100),
    Details NVARCHAR(MAX),
    Timestamp DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_AuditLogs_User FOREIGN KEY(UserId) REFERENCES Users(UserId)
);

-- FEEDBACKS: Citizen suggestions
CREATE TABLE Feedbacks (
    FeedbackId CHAR(4) PRIMARY KEY,
    UserId CHAR(4) NOT NULL,
	Category NVARCHAR(50) DEFAULT 'General',
	Priority NVARCHAR(20) DEFAULT 'Medium',
	Subject NVARCHAR(200),
	Rating INT DEFAULT 0,
	FollowUp BIT DEFAULT 0;
    Message NVARCHAR(1000),
    CreatedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_Feedbacks_User FOREIGN KEY(UserId) REFERENCES Users(UserId)
);
WHERE Category IS NULL;
CREATE TABLE PickupVerifications (
    VerificationId CHAR(4) PRIMARY KEY,
    PickupId CHAR(4) NOT NULL,
    VerifiedKg DECIMAL(6,2) NOT NULL,
    MaterialType NVARCHAR(50),
    VerificationMethod NVARCHAR(50),
    VerifiedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_PickupVerifications_Pickup FOREIGN KEY(PickupId) REFERENCES PickupRequests(PickupId)
);

-- Create UserActivities table for recent activity feed
CREATE TABLE UserActivities (
    ActivityId INT IDENTITY(1,1) PRIMARY KEY,
    UserId CHAR(4) NOT NULL,
    ActivityType NVARCHAR(50) NOT NULL,
    Description NVARCHAR(255) NOT NULL,
    Points DECIMAL(10,2) DEFAULT 0,
    Timestamp DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_UserActivities_Users FOREIGN KEY(UserId) REFERENCES Users(UserId)
);

-- Error Log for analytics
CREATE TABLE ErrorLogs (
    ErrorId INT IDENTITY(1,1) PRIMARY KEY,
    ErrorType NVARCHAR(50) NOT NULL,
    Url NVARCHAR(500) NOT NULL,
    UserIP NVARCHAR(50),
    UserAgent NVARCHAR(500),
    Referrer NVARCHAR(500),
    CreatedAt DATETIME DEFAULT GETDATE()
);

-- Support Tickets for User Related Issues
CREATE TABLE SupportTickets (
    TicketId NVARCHAR(50) PRIMARY KEY,
    UserId NVARCHAR(50) NULL,
    FullName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(100) NOT NULL,
    IssueType NVARCHAR(50) NOT NULL,
    Priority NVARCHAR(20) NOT NULL,
    Description NVARCHAR(MAX) NOT NULL,
    AttachScreenshot BIT NOT NULL DEFAULT 0,
    Status NVARCHAR(20) NOT NULL DEFAULT 'Open',
    CreatedDate DATETIME NOT NULL DEFAULT GETDATE(),
    ResolvedDate DATETIME NULL
);

-- Collector Routes table
CREATE TABLE CollectorRoutes (
    RouteId NVARCHAR(50) PRIMARY KEY,
    CollectorId CHAR(4) NOT NULL,
    RouteDate DATETIME NOT NULL,
    VehicleId NVARCHAR(50) NULL,
    RouteType NVARCHAR(50) DEFAULT 'daily',
    StartTime DATETIME NULL,
    BreakTime DATETIME NULL,
    EndTime DATETIME NULL,
    TotalDistance DECIMAL(10,2) DEFAULT 0,
    TotalWeight DECIMAL(10,2) DEFAULT 0,
    Notes NVARCHAR(MAX) NULL,
    Status NVARCHAR(20) DEFAULT 'Planned',
    CreatedAt DATETIME DEFAULT GETDATE(),
    LastUpdated DATETIME NULL,
    CONSTRAINT FK_CollectorRoutes_Collector FOREIGN KEY(CollectorId) REFERENCES Users(UserId)
);

-- Collector Locations for real-time tracking
CREATE TABLE CollectorLocations (
    LocationId INT IDENTITY(1,1) PRIMARY KEY,
    CollectorId CHAR(4) NOT NULL,
    Lat DECIMAL(10,6) NOT NULL,
    Lng DECIMAL(10,6) NOT NULL,
    Timestamp DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_CollectorLocations_Collector FOREIGN KEY(CollectorId) REFERENCES Users(UserId)
);

-- Vehicles table
CREATE TABLE Vehicles (
    VehicleId NVARCHAR(50) PRIMARY KEY,
    VehicleType NVARCHAR(50) NOT NULL,
    LicensePlate NVARCHAR(20) UNIQUE NOT NULL,
    Capacity DECIMAL(10,2) NOT NULL, -- in kg
    FuelType NVARCHAR(20) DEFAULT 'Diesel',
    Status NVARCHAR(20) DEFAULT 'Active',
    AssignedTo CHAR(4) NULL,
    LastMaintenance DATE NULL,
    NextMaintenance DATE NULL,
    CreatedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_Vehicles_Collector FOREIGN KEY(AssignedTo) REFERENCES Users(UserId)
);

-- Route Optimizations table
CREATE TABLE RouteOptimizations (
    OptimizationId INT IDENTITY(1,1) PRIMARY KEY,
    RouteId NVARCHAR(50) NOT NULL,
    OptimizationType NVARCHAR(50) NOT NULL,
    OriginalDistance DECIMAL(10,2) NOT NULL,
    OptimizedDistance DECIMAL(10,2) NOT NULL,
    TimeSaved INT NOT NULL, -- in minutes
    FuelSaved DECIMAL(10,2) NOT NULL, -- in liters
    OptimizationData NVARCHAR(MAX) NULL,
    CreatedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_RouteOptimizations_Route FOREIGN KEY(RouteId) REFERENCES CollectorRoutes(RouteId)
);


-- ========================================
-- 3. INDEXES
-- ========================================
CREATE INDEX IX_Users_Email ON Users(Email);
CREATE INDEX IX_WasteReports_Date ON WasteReports(CreatedAt);
CREATE INDEX IX_PickupRequests_Status ON PickupRequests(Status);
CREATE INDEX IX_RewardPoints_UserId ON RewardPoints(UserId);
CREATE INDEX IX_Notifications_IsRead ON Notifications(IsRead);
CREATE INDEX IX_ErrorLogs_CreatedAt ON ErrorLogs(CreatedAt);
CREATE INDEX IX_ErrorLogs_ErrorType ON ErrorLogs(ErrorType);
CREATE INDEX IX_CollectorRoutes_CollectorDate ON CollectorRoutes(CollectorId, RouteDate);
CREATE INDEX IX_PickupRequests_CollectorStatus ON PickupRequests(CollectorId, Status);
CREATE INDEX IX_PickupRequests_ScheduledDate ON PickupRequests(ScheduledAt);
-- ========================================
-- 4. VIEWS
-- ========================================

-- vw_ActivePickups: Displays all pickups that are pending or assigned
CREATE VIEW vw_ActivePickups AS
SELECT p.PickupId, w.Address, w.PhotoUrl, u.FullName AS CitizenName,
       c.FullName AS CollectorName, p.Status
FROM PickupRequests p
JOIN WasteReports w ON p.ReportId = w.ReportId
JOIN Users u ON w.UserId = u.UserId
LEFT JOIN Users c ON p.CollectorId = c.UserId
WHERE p.Status IN ('Requested','Assigned');

-- vw_UserRewardSummary: Summarizes total reward points per user
CREATE VIEW vw_UserRewardSummary AS
SELECT u.FullName, u.Phone, SUM(r.Amount) AS TotalCredits
FROM Users u
LEFT JOIN RewardPoints r ON u.UserId = r.UserId
GROUP BY u.FullName, u.Phone;

-- ========================================
-- 5. STORED PROCEDURES
-- ========================================

ALTER PROCEDURE sp_AddWasteReport
    @UserId CHAR(4),
    @WasteTypeId CHAR(4),
    @EstimatedKg DECIMAL(6,2),
    @Address NVARCHAR(300),
    @Lat DECIMAL(10,6) = NULL,
    @Lng DECIMAL(10,6) = NULL,
    @PhotoUrl NVARCHAR(512) = NULL
AS
BEGIN
    INSERT INTO WasteReports(UserId, WasteTypeId, EstimatedKg, Address, Lat, Lng, PhotoUrl)
    VALUES(@UserId, @WasteTypeId, @EstimatedKg, @Address, @Lat, @Lng, @PhotoUrl);
END
GO
-- sp_AddWasteReport: Inserts a new citizen waste report
CREATE PROCEDURE sp_AddWasteReport
    @UserId UNIQUEIDENTIFIER,
    @WasteTypeId INT,
    @EstimatedKg DECIMAL(6,2),
    @Address NVARCHAR(300),
    @Lat DECIMAL(10,6) = NULL,
    @Lng DECIMAL(10,6) = NULL,
    @PhotoUrl NVARCHAR(512) = NULL
AS
BEGIN
    INSERT INTO WasteReports(UserId, WasteTypeId, EstimatedKg, Address, Lat, Lng, PhotoUrl)
    VALUES(@UserId, @WasteTypeId, @EstimatedKg, @Address, @Lat, @Lng, @PhotoUrl);
END
GO

-- sp_AssignPickup: Assigns a collector to a pending pickup request
CREATE PROCEDURE sp_AssignPickup
    @PickupId UNIQUEIDENTIFIER,
    @CollectorId UNIQUEIDENTIFIER
AS
BEGIN
    UPDATE PickupRequests
    SET CollectorId = @CollectorId,
        Status = 'Assigned'
    WHERE PickupId = @PickupId;
END
GO

-- sp_CompletePickup: Verifies a pickup, adds reward points and logs completion
CREATE PROCEDURE sp_CompletePickup
    @PickupId UNIQUEIDENTIFIER,
    @VerifiedKg DECIMAL(6,2),
    @MaterialType NVARCHAR(50)
AS
BEGIN
    INSERT INTO PickupVerifications(PickupId, VerifiedKg, MaterialType, VerificationMethod)
    VALUES(@PickupId, @VerifiedKg, @MaterialType, 'Manual');

    DECLARE @UserId UNIQUEIDENTIFIER = (SELECT w.UserId FROM WasteReports w
                                        JOIN PickupRequests p ON w.ReportId = p.ReportId
                                        WHERE p.PickupId = @PickupId);

    DECLARE @CreditRate DECIMAL(5,2) = (SELECT CreditPerKg FROM WasteTypes WHERE Name = @MaterialType);

    INSERT INTO RewardPoints(UserId, Amount, Type, Reference)
    VALUES(@UserId, @VerifiedKg * @CreditRate, 'Credit', 'Pickup ' + CAST(@PickupId AS NVARCHAR(36)));

    UPDATE PickupRequests
    SET Status = 'Collected',
        CompletedAt = GETDATE()
    WHERE PickupId = @PickupId;
END
GO

-- ========================================
-- 6. TRIGGERS
-- ========================================

-- trg_LogWasteReport: Logs every new waste report for auditing
CREATE TRIGGER trg_LogWasteReport
ON WasteReports
AFTER INSERT
AS
BEGIN
    DECLARE @NextAuditId INT;
    
    -- Get the next AuditId
    SELECT @NextAuditId = ISNULL(MAX(CAST(SUBSTRING(AuditId, 3, LEN(AuditId)) AS INT)), 0) + 1 
    FROM AuditLogs 
    WHERE AuditId LIKE 'AL%';
    
    -- Insert with generated AuditId
    INSERT INTO AuditLogs (AuditId, UserId, Action, Details, Timestamp)
    SELECT 
        'AL' + RIGHT('00' + CAST(@NextAuditId + ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) - 1 AS VARCHAR(2)), 2),
        UserId, 
        'New Waste Report', 
        'ReportId: ' + CAST(ReportId AS NVARCHAR(10)),
        GETDATE()
    FROM inserted;
END
GO

-- ========================================
-- 7. ADDITIONAL TRIGGERS FOR USER ACTIVITIES
-- ========================================

-- Trigger for new waste reports
IF NOT EXISTS (SELECT * FROM sys.triggers WHERE name = 'trg_AfterWasteReport')
BEGIN
    EXEC('CREATE TRIGGER trg_AfterWasteReport
    ON WasteReports
    AFTER INSERT
    AS
    BEGIN
        DECLARE @UserId CHAR(4), @ReportId CHAR(4), @WasteType NVARCHAR(50)
        
        SELECT @UserId = UserId, @ReportId = ReportId FROM inserted
        SELECT @WasteType = Name FROM WasteTypes wt 
        JOIN inserted i ON wt.WasteTypeId = i.WasteTypeId
        
        INSERT INTO UserActivities (UserId, ActivityType, Description, Points, Timestamp)
        VALUES (@UserId, ''WasteReport'', 
                ''Reported '' + @WasteType + '' for collection'', 
                5, GETDATE())
    END')
END
GO

-- Trigger for completed pickups
IF NOT EXISTS (SELECT * FROM sys.triggers WHERE name = 'trg_AfterPickupComplete')
BEGIN
    EXEC('CREATE TRIGGER trg_AfterPickupComplete
    ON PickupRequests
    AFTER UPDATE
    AS
    BEGIN
        IF UPDATE(Status) AND EXISTS(SELECT 1 FROM inserted WHERE Status = ''Collected'')
        BEGIN
            DECLARE @UserId CHAR(4), @PickupId CHAR(4), @Points DECIMAL(10,2)
            
            SELECT @PickupId = PickupId FROM inserted
            SELECT @UserId = wr.UserId, @Points = pv.VerifiedKg * wt.CreditPerKg
            FROM PickupRequests pr
            JOIN WasteReports wr ON pr.ReportId = wr.ReportId
            JOIN PickupVerifications pv ON pr.PickupId = pv.PickupId
            JOIN WasteTypes wt ON wr.WasteTypeId = wt.WasteTypeId
            WHERE pr.PickupId = @PickupId
            
            INSERT INTO UserActivities (UserId, ActivityType, Description, Points, Timestamp)
            VALUES (@UserId, ''PickupComplete'', 
                    ''Pickup completed - '' + CAST(@Points AS NVARCHAR(10)) + '' credits earned'', 
                    @Points, GETDATE())
        END
    END')
END
GO

-- Trigger for reward points
IF NOT EXISTS (SELECT * FROM sys.triggers WHERE name = 'trg_AfterRewardPoints')
BEGIN
    EXEC('CREATE TRIGGER trg_AfterRewardPoints
    ON RewardPoints
    AFTER INSERT
    AS
    BEGIN
        DECLARE @UserId CHAR(4), @Amount DECIMAL(10,2), @Type NVARCHAR(50)
        
        SELECT @UserId = UserId, @Amount = Amount, @Type = Type FROM inserted
        
        UPDATE Users 
        SET XP_Credits = XP_Credits + @Amount 
        WHERE UserId = @UserId
    END')
END
GO

-- ========================================
-- ADDITIONAL STORED PROCEDURES FOR CITIZEN ACTIVITIES
-- ========================================

-- Procedure to get citizen dashboard data
IF NOT EXISTS (SELECT * FROM sys.procedures WHERE name = 'sp_GetCitizenDashboard')
BEGIN
    EXEC('CREATE PROCEDURE sp_GetCitizenDashboard
        @UserId CHAR(4)
    AS
    BEGIN
        -- Total credits
        SELECT ISNULL(SUM(Amount), 0) AS TotalCredits 
        FROM RewardPoints 
        WHERE UserId = @UserId
        
        -- Recent activities
        SELECT TOP 5 ActivityType, Description, Points, Timestamp
        FROM UserActivities 
        WHERE UserId = @UserId 
        ORDER BY Timestamp DESC
        
        -- Pending pickups
        SELECT COUNT(*) AS PendingPickups
        FROM PickupRequests pr
        JOIN WasteReports wr ON pr.ReportId = wr.ReportId
        WHERE wr.UserId = @UserId AND pr.Status IN (''Requested'', ''Assigned'')
        
        -- Monthly stats
        SELECT 
            DATENAME(MONTH, CreatedAt) AS MonthName,
            COUNT(*) AS ReportsCount,
            ISNULL(SUM(EstimatedKg), 0) AS TotalKg
        FROM WasteReports 
        WHERE UserId = @UserId AND YEAR(CreatedAt) = YEAR(GETDATE())
        GROUP BY DATENAME(MONTH, CreatedAt), MONTH(CreatedAt)
        ORDER BY MONTH(CreatedAt)
    END')
END
GO

-- Procedure for waste reporting with activity tracking
IF NOT EXISTS (SELECT * FROM sys.procedures WHERE name = 'sp_SubmitWasteReport')
BEGIN
    EXEC('CREATE PROCEDURE sp_SubmitWasteReport
        @UserId CHAR(4),
        @WasteTypeId CHAR(4),
        @EstimatedKg DECIMAL(6,2),
        @Address NVARCHAR(300),
        @Lat DECIMAL(10,6) = NULL,
        @Lng DECIMAL(10,6) = NULL,
        @PhotoUrl NVARCHAR(512) = NULL
    AS
    BEGIN
        DECLARE @ReportId CHAR(4)
        
        -- Generate ReportId
        SELECT @ReportId = ''WR'' + RIGHT(''00'' + CAST(ISNULL(MAX(CAST(SUBSTRING(ReportId, 3, 2) AS INT)), 0) + 1 AS VARCHAR(2)), 2)
        FROM WasteReports
        
        -- Insert waste report
        INSERT INTO WasteReports (ReportId, UserId, WasteTypeId, EstimatedKg, Address, Lat, Lng, PhotoUrl)
        VALUES (@ReportId, @UserId, @WasteTypeId, @EstimatedKg, @Address, @Lat, @Lng, @PhotoUrl)
        
        -- Create pickup request
        DECLARE @PickupId CHAR(4)
        SELECT @PickupId = ''PK'' + RIGHT(''00'' + CAST(ISNULL(MAX(CAST(SUBSTRING(PickupId, 3, 2) AS INT)), 0) + 1 AS VARCHAR(2)), 2)
        FROM PickupRequests
        
        INSERT INTO PickupRequests (PickupId, ReportId, Status)
        VALUES (@PickupId, @ReportId, ''Requested'')
    END')
END
GO

-- ========================================
-- ADDITIONAL INDEXES FOR PERFORMANCE
-- ========================================

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_UserActivities_UserId')
BEGIN
    CREATE INDEX IX_UserActivities_UserId ON UserActivities(UserId);
END

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_UserActivities_Timestamp')
BEGIN
    CREATE INDEX IX_UserActivities_Timestamp ON UserActivities(Timestamp DESC);
END

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_PickupVerifications_PickupId')
BEGIN
    CREATE INDEX IX_PickupVerifications_PickupId ON PickupVerifications(PickupId);
END

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_RewardPoints_CreatedAt')
BEGIN
    CREATE INDEX IX_RewardPoints_CreatedAt ON RewardPoints(CreatedAt DESC);
END
GO

-- ========================================
-- ADDITIONAL VIEWS FOR REPORTING
-- ========================================

IF NOT EXISTS (SELECT * FROM sys.views WHERE name = 'vw_CitizenActivitySummary')
BEGIN
    EXEC('CREATE VIEW vw_CitizenActivitySummary AS
    SELECT 
        u.UserId,
        u.FullName,
        u.Phone,
        ISNULL(SUM(rp.Amount), 0) AS TotalCredits,
        COUNT(DISTINCT wr.ReportId) AS TotalReports,
        COUNT(DISTINCT pr.PickupId) AS TotalPickups,
        ISNULL(SUM(pv.VerifiedKg), 0) AS TotalKgRecycled,
        MAX(ua.Timestamp) AS LastActivity
    FROM Users u
    LEFT JOIN WasteReports wr ON u.UserId = wr.UserId
    LEFT JOIN PickupRequests pr ON wr.ReportId = pr.ReportId
    LEFT JOIN PickupVerifications pv ON pr.PickupId = pv.PickupId
    LEFT JOIN RewardPoints rp ON u.UserId = rp.UserId
    LEFT JOIN UserActivities ua ON u.UserId = ua.UserId
    WHERE u.RoleId IN (''CITZ'', ''R001'')
    GROUP BY u.UserId, u.FullName, u.Phone')
END
GO

IF NOT EXISTS (SELECT * FROM sys.views WHERE name = 'vw_RecentUserActivities')
BEGIN
    EXEC('CREATE VIEW vw_RecentUserActivities AS
    SELECT 
        ua.ActivityId,
        ua.UserId,
        u.FullName,
        ua.ActivityType,
        ua.Description,
        ua.Points,
        ua.Timestamp
    FROM UserActivities ua
    JOIN Users u ON ua.UserId = u.UserId
    WHERE ua.Timestamp >= DATEADD(DAY, -30, GETDATE())')
END
GO


-- ========================================
-- 8. PHASE TWO (C2 FILE)
-- ========================================
USE SoorGreenDB;
GO

/**********************************************
  PHASE 2 ENHANCEMENT SCRIPT - SoorGreenDB
  - Add RBAC tables
  - Soft delete + MunicipalityId on business tables
  - AI tables and columns
  - MediaFiles, EventLog, Validation tables
  - Extended AuditLogs
  - RLS predicate functions & policies (SQL Server)
  - Partition function/scheme placeholders
  - Helpful indexes
**********************************************/

-------------------------------------------------------------------
-- 1) RBAC: Permissions, RolePermissions, UserRoles
-------------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'Permissions')
BEGIN
CREATE TABLE Permissions (
    PermissionCode NVARCHAR(100) PRIMARY KEY,
    Description NVARCHAR(300) NULL
);
END

IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'RolePermissions')
BEGIN
CREATE TABLE RolePermissions (
    RoleId CHAR(4) NOT NULL,
    PermissionCode NVARCHAR(100) NOT NULL,
    CONSTRAINT FK_RP_Roles FOREIGN KEY (RoleId) REFERENCES Roles(RoleId),
    CONSTRAINT FK_RP_Perms FOREIGN KEY (PermissionCode) REFERENCES Permissions(PermissionCode),
    CONSTRAINT PK_RolePermissions PRIMARY KEY (RoleId, PermissionCode)
);
END

IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'UserRoles')
BEGIN
CREATE TABLE UserRoles (
    UserRoleId INT IDENTITY(1,1) PRIMARY KEY,
    UserId CHAR(4) NOT NULL,
    RoleId CHAR(4) NOT NULL,
    AssignedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_UserRoles_Users FOREIGN KEY (UserId) REFERENCES Users(UserId),
    CONSTRAINT FK_UserRoles_Roles FOREIGN KEY (RoleId) REFERENCES Roles(RoleId)
);
END

-- Seed some permissions if they don't exist
IF NOT EXISTS (SELECT 1 FROM Permissions WHERE PermissionCode = 'REPORT_CREATE')
    INSERT INTO Permissions (PermissionCode, Description) VALUES ('REPORT_CREATE','Create a waste report');
IF NOT EXISTS (SELECT 1 FROM Permissions WHERE PermissionCode = 'PICKUP_ASSIGN')
    INSERT INTO Permissions (PermissionCode, Description) VALUES ('PICKUP_ASSIGN','Assign pickup to collector');
IF NOT EXISTS (SELECT 1 FROM Permissions WHERE PermissionCode = 'VIEW_ANALYTICS')
    INSERT INTO Permissions (PermissionCode, Description) VALUES ('VIEW_ANALYTICS','View analytics and dashboards');

-------------------------------------------------------------------
-- 2) Soft delete + MunicipalityId and extra columns for business tables
-- Add columns with IF NOT EXISTS checks so it's safe to re-run
-------------------------------------------------------------------

-- Utility: add column if not exists
CREATE PROCEDURE dbo.__AddColumnIfNotExists
    @SchemaName SYSNAME,
    @TableName SYSNAME,
    @ColumnDDL NVARCHAR(MAX)
AS
BEGIN
    DECLARE @sql NVARCHAR(MAX);
    IF NOT EXISTS (
        SELECT 1
        FROM sys.columns c
        JOIN sys.objects o ON c.object_id = o.object_id
        JOIN sys.schemas s ON o.schema_id = s.schema_id
        WHERE s.name = @SchemaName AND o.name = @TableName AND c.name = PARSENAME(REPLACE(@ColumnDDL,' ','.'),1)
    )
    BEGIN
        SET @sql = N'ALTER TABLE ' + QUOTENAME(@SchemaName) + '.' + QUOTENAME(@TableName) + ' ADD ' + @ColumnDDL;
        EXEC sp_executesql @sql;
    END
END;
GO

-- Add common lifecycle/soft-delete fields to core tables
EXEC dbo.__AddColumnIfNotExists 'dbo','Users','IsDeleted BIT DEFAULT 0';
EXEC dbo.__AddColumnIfNotExists 'dbo','Users','DeletedAt DATETIME NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','Users','DeletedBy CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','Users','DeviceId NVARCHAR(100) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','Users','TwoFactorEnabled BIT DEFAULT 0';

EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','IsDeleted BIT DEFAULT 0';
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','DeletedAt DATETIME NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','DeletedBy CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','MunicipalityId CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','Severity INT NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','PredictedWasteType NVARCHAR(100) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','AIConfidence FLOAT NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','Metadata NVARCHAR(MAX) NULL'; -- JSON / bounding boxes
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','IsHazardous BIT DEFAULT 0';
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','VerifiedByAdminID CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','VerifiedAt DATETIME NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','WasteReports','StatusUpdatedAt DATETIME NULL';

-- Ensure foreign key to Municipalities (nullable)
IF NOT EXISTS (SELECT 1 FROM sys.foreign_keys WHERE name = 'FK_WasteReports_Municipalities')
BEGIN
    ALTER TABLE dbo.WasteReports
    ADD CONSTRAINT FK_WasteReports_Municipalities FOREIGN KEY (MunicipalityId) REFERENCES Municipalities(MunicipalityId);
END

EXEC dbo.__AddColumnIfNotExists 'dbo','PickupRequests','IsDeleted BIT DEFAULT 0';
EXEC dbo.__AddColumnIfNotExists 'dbo','PickupRequests','DeletedAt DATETIME NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','PickupRequests','DeletedBy CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','PickupRequests','MunicipalityId CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','PickupRequests','AutoAssignedByAI BIT DEFAULT 0';
EXEC dbo.__AddColumnIfNotExists 'dbo','PickupRequests','CompletionProofImage NVARCHAR(512) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','PickupRequests','CompletionGPSLat DECIMAL(10,6) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','PickupRequests','CompletionGPSLong DECIMAL(10,6) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','PickupRequests','IsOverdue BIT DEFAULT 0';

-- Add municipality to CollectorRoutes, CollectorLocations, RewardPoints, Notifications, AuditLogs, Feedbacks
EXEC dbo.__AddColumnIfNotExists 'dbo','CollectorRoutes','MunicipalityId CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','CollectorLocations','MunicipalityId CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','RewardPoints','MunicipalityId CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','Notifications','MunicipalityId CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','AuditLogs','MunicipalityId CHAR(4) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','Feedbacks','MunicipalityId CHAR(4) NULL';

-- Add FK from these tables to Municipalities if not exists (safe because nullable)
IF NOT EXISTS (SELECT 1 FROM sys.foreign_keys WHERE name = 'FK_CollectorRoutes_Municipalities')
BEGIN
    ALTER TABLE dbo.CollectorRoutes
    ADD CONSTRAINT FK_CollectorRoutes_Municipalities FOREIGN KEY (MunicipalityId) REFERENCES Municipalities(MunicipalityId);
END
IF NOT EXISTS (SELECT 1 FROM sys.foreign_keys WHERE name = 'FK_CollectorLocations_Municipalities')
BEGIN
    ALTER TABLE dbo.CollectorLocations
    ADD CONSTRAINT FK_CollectorLocations_Municipalities FOREIGN KEY (MunicipalityId) REFERENCES Municipalities(MunicipalityId);
END
IF NOT EXISTS (SELECT 1 FROM sys.foreign_keys WHERE name = 'FK_RewardPoints_Municipalities')
BEGIN
    ALTER TABLE dbo.RewardPoints
    ADD CONSTRAINT FK_RewardPoints_Municipalities FOREIGN KEY (MunicipalityId) REFERENCES Municipalities(MunicipalityId);
END

-- Add soft-delete & audit fields to other tables that will benefit
EXEC dbo.__AddColumnIfNotExists 'dbo','Vehicles','IsDeleted BIT DEFAULT 0';
EXEC dbo.__AddColumnIfNotExists 'dbo','Vehicles','MunicipalityId CHAR(4) NULL';
IF NOT EXISTS (SELECT 1 FROM sys.foreign_keys WHERE name = 'FK_Vehicles_Municipalities')
BEGIN
    ALTER TABLE dbo.Vehicles
    ADD CONSTRAINT FK_Vehicles_Municipalities FOREIGN KEY (MunicipalityId) REFERENCES Municipalities(MunicipalityId);
END

-- Add IsDeleted to UserActivities and ErrorLogs
EXEC dbo.__AddColumnIfNotExists 'dbo','UserActivities','IsDeleted BIT DEFAULT 0';
EXEC dbo.__AddColumnIfNotExists 'dbo','ErrorLogs','IsDeleted BIT DEFAULT 0';

-------------------------------------------------------------------
-- 3) AI Tables: Raw data, FeatureStore, ModelRegistry, Predictions, Feedback, Insights
-------------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'AI_RawData')
BEGIN
CREATE TABLE AI_RawData (
    DataId BIGINT IDENTITY(1,1) PRIMARY KEY,
    SourceTable NVARCHAR(128),
    SourceId NVARCHAR(128) NULL,
    JsonPayload NVARCHAR(MAX) NULL, -- snapshot for training
    CapturedAt DATETIME DEFAULT GETDATE()
);
END

IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'AI_FeatureStore')
BEGIN
CREATE TABLE AI_FeatureStore (
    FeatureId BIGINT IDENTITY(1,1) PRIMARY KEY,
    RelatedEntity NVARCHAR(128) NULL,
    RelatedEntityId NVARCHAR(128) NULL,
    FeatureName NVARCHAR(200),
    FeatureValue NVARCHAR(MAX),
    CreatedAt DATETIME DEFAULT GETDATE()
);
END

IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'AI_ModelRegistry')
BEGIN
CREATE TABLE AI_ModelRegistry (
    ModelId INT IDENTITY(1,1) PRIMARY KEY,
    ModelName NVARCHAR(200) NOT NULL,
    Version NVARCHAR(50) NOT NULL,
    Framework NVARCHAR(50) NULL,
    FilePath NVARCHAR(500) NULL,
    Description NVARCHAR(MAX) NULL,
    Deployed BIT DEFAULT 0,
    CreatedAt DATETIME DEFAULT GETDATE()
);
END

IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'AI_Predictions')
BEGIN
CREATE TABLE AI_Predictions (
    PredictionId BIGINT IDENTITY(1,1) PRIMARY KEY,
    ReportId CHAR(4) NULL,
    ModelId INT NULL,
    PredictedWasteType NVARCHAR(100) NULL,
    Confidence FLOAT NULL,
    Severity INT NULL,
    BoundingBoxes NVARCHAR(MAX) NULL, -- JSON array of bboxes if any
    PredictionTimestamp DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_AIPreds_Model FOREIGN KEY(ModelId) REFERENCES AI_ModelRegistry(ModelId),
    CONSTRAINT FK_AIPreds_Report FOREIGN KEY(ReportId) REFERENCES WasteReports(ReportId)
);
END

IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'AI_FeedbackLoop')
BEGIN
CREATE TABLE AI_FeedbackLoop (
    FeedbackId BIGINT IDENTITY(1,1) PRIMARY KEY,
    PredictionId BIGINT NOT NULL,
    ReviewerId CHAR(4) NULL,
    CorrectLabel NVARCHAR(100) NULL,
    Comments NVARCHAR(MAX) NULL,
    ReviewedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_AIFeed_Pred FOREIGN KEY(PredictionId) REFERENCES AI_Predictions(PredictionId)
);
END

IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'AI_Insights')
BEGIN
CREATE TABLE AI_Insights (
    InsightId BIGINT IDENTITY(1,1) PRIMARY KEY,
    Category NVARCHAR(200) NULL,
    Data NVARCHAR(MAX) NULL,
    GeneratedAt DATETIME DEFAULT GETDATE()
);
END

-------------------------------------------------------------------
-- 4) MediaFiles table (store URIs to blob storage) and EventLog
-------------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'MediaFiles')
BEGIN
CREATE TABLE MediaFiles (
    FileId NVARCHAR(100) PRIMARY KEY,
    UserId CHAR(4) NULL,
    EntityType NVARCHAR(100) NULL, -- e.g., 'WasteReport','Pickup','User'
    EntityId NVARCHAR(100) NULL,
    FileUrl NVARCHAR(1000) NOT NULL,
    FileType NVARCHAR(50) NULL,
    SizeBytes BIGINT NULL,
    CreatedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_MediaFiles_Users FOREIGN KEY (UserId) REFERENCES Users(UserId)
);
END

IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'EventLog')
BEGIN
CREATE TABLE EventLog (
    EventId BIGINT IDENTITY(1,1) PRIMARY KEY,
    EventType NVARCHAR(200) NOT NULL,
    Payload NVARCHAR(MAX) NULL,
    Source NVARCHAR(200) NULL,
    CreatedAt DATETIME DEFAULT GETDATE()
);
END

-------------------------------------------------------------------
-- 5) Validation Rules & ValidationErrors
-------------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'ValidationRules')
BEGIN
CREATE TABLE ValidationRules (
    RuleId INT IDENTITY(1,1) PRIMARY KEY,
    EntityName NVARCHAR(200) NOT NULL,
    FieldName NVARCHAR(200) NOT NULL,
    RuleType NVARCHAR(50) NOT NULL, -- Regex, Range, Required, Enum
    RuleValue NVARCHAR(1000) NULL,
    CreatedAt DATETIME DEFAULT GETDATE()
);
END

IF NOT EXISTS (SELECT 1 FROM sys.tables WHERE name = 'ValidationErrors')
BEGIN
CREATE TABLE ValidationErrors (
    ErrorId BIGINT IDENTITY(1,1) PRIMARY KEY,
    EntityName NVARCHAR(200),
    FieldName NVARCHAR(200),
    ErrorMessage NVARCHAR(1000),
    RowSnapshot NVARCHAR(MAX) NULL, -- JSON of the offending row
    CreatedAt DATETIME DEFAULT GETDATE()
);
END

-------------------------------------------------------------------
-- 6) Enhance AuditLogs: add IP, DeviceInfo, ChangedFields JSON, ActionSeverity
-------------------------------------------------------------------
EXEC dbo.__AddColumnIfNotExists 'dbo','AuditLogs','IPAddress NVARCHAR(50) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','AuditLogs','DeviceInfo NVARCHAR(500) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','AuditLogs','ChangedFields NVARCHAR(MAX) NULL';
EXEC dbo.__AddColumnIfNotExists 'dbo','AuditLogs','ActionSeverity NVARCHAR(20) NULL';

-------------------------------------------------------------------
-- 7) Row-Level Security (RLS) - predicate functions & security policies
-- NOTE: Requires SQL Server Enterprise/Standard features. If your instance
-- doesn't allow creating security policies, you can omit these or run later.
-------------------------------------------------------------------

/* 7.a) Predicate function for Users: allow user to select only their own row (for applications that use EXECUTE AS or application roles) */
IF OBJECT_ID('dbo.fn_securitypredicate_UserAccess','IF') IS NULL
BEGIN
    EXEC('
    CREATE FUNCTION dbo.fn_securitypredicate_UserAccess(@UserId CHAR(4))
    RETURNS TABLE
    WITH SCHEMABINDING
    AS
    RETURN SELECT 1 AS fn_securitypredicate_UserAccessResult WHERE @UserId = SUSER_NAME() OR EXISTS(SELECT 1 FROM dbo.Users u WHERE u.UserId = SUSER_SNAME() AND u.RoleId IN (SELECT RoleId FROM Roles WHERE RoleName = ''Admin'')) 
    ');
END
-- Note: SUSER_NAME / SUSER_SNAME usage above is placeholder. In many setups you map application user context to DB user or use session context. We'll provide a safer, pragmatic policy below that uses SESSION_CONTEXT key.

-- 7.b) Helper: session enforcement function using SESSION_CONTEXT('app_user')
-- This function checks if current row's UserId equals SESSION_CONTEXT('app_user') OR user has admin role.
IF OBJECT_ID('dbo.fn_rls_userpredicate','IF') IS NULL
BEGIN
EXEC('
CREATE FUNCTION dbo.fn_rls_userpredicate(@UserId CHAR(4))
RETURNS TABLE
WITH SCHEMABINDING
AS
RETURN
(
    SELECT 1 AS accessResult
    WHERE
    (
        -- allow if session context app_user matches @UserId
        ISNULL(SESSION_CONTEXT(N''app_user''), N'''') = @UserId
        OR
        -- OR session context app_roles has ADMIN (simple text check)
        CHARINDEX(N''ADMIN'', ISNULL(SESSION_CONTEXT(N''app_roles''), N'''')) > 0
    )
)
');
END

-- 7.c) Create RLS policy for WasteReports (read access)
IF NOT EXISTS (SELECT 1 FROM sys.security_policies WHERE name = 'policy_RLS_WasteReports')
BEGIN
    EXEC('
    CREATE SECURITY POLICY policy_RLS_WasteReports
    ADD FILTER PREDICATE dbo.fn_rls_userpredicate(UserId) ON dbo.WasteReports
    WITH (STATE = ON)
    ');
END

-- 7.d) Create RLS policy for PickupRequests: allow collectors to see assigned, citizens to see own
IF NOT EXISTS (SELECT 1 FROM sys.security_policies WHERE name = 'policy_RLS_PickupRequests')
BEGIN
    EXEC('
    CREATE FUNCTION dbo.fn_rls_pickuppredicate(@CollectorId CHAR(4))
    RETURNS TABLE
    WITH SCHEMABINDING
    AS
    RETURN
    (
        SELECT 1 AS rp
        WHERE
            -- session user equals the collector assigned
            ISNULL(SESSION_CONTEXT(N''app_user''), N'''') = @CollectorId
            OR CHARINDEX(N''ADMIN'', ISNULL(SESSION_CONTEXT(N''app_roles''), N'''')) > 0
    );

    CREATE SECURITY POLICY policy_RLS_PickupRequests
    ADD FILTER PREDICATE dbo.fn_rls_pickuppredicate(CollectorId) ON dbo.PickupRequests
    WITH (STATE = ON)
    ');
END

-- Note: RLS setup above assumes the application will set SESSION_CONTEXT('app_user') and SESSION_CONTEXT('app_roles')
-- Example: EXEC sp_set_session_context 'app_user', 'U002';

-------------------------------------------------------------------
-- 8) Partitioning   placeholders (create function & scheme only if needed)
-- This creates a year-based partition function and scheme. Adjust filegroups manually for production.
-------------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM sys.partition_functions WHERE name = 'pf_WasteReports_ByYear')
BEGIN
    -- boundaries: 2023, 2024, 2025, 2026 ... adjust as required for production
    CREATE PARTITION FUNCTION pf_WasteReports_ByYear (DATETIME)
    AS RANGE RIGHT FOR VALUES ('2023-01-01','2024-01-01','2025-01-01','2026-01-01');
END

IF NOT EXISTS (SELECT 1 FROM sys.partition_schemes WHERE name = 'ps_WasteReports_ByYear')
BEGIN
    -- This will map all partitions to PRIMARY. In production, map to filegroups.
    CREATE PARTITION SCHEME ps_WasteReports_ByYear
    AS PARTITION pf_WasteReports_ByYear ALL TO ([PRIMARY]);
END

-- You can later switch WasteReports to partition scheme using SWITCH or creating a new table with scheme and migrating data.

-------------------------------------------------------------------
-- 9) Useful Indexes for new columns
-------------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_WasteReports_Municipality')
BEGIN
    CREATE INDEX IX_WasteReports_Municipality ON dbo.WasteReports(MunicipalityId);
END
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_WasteReports_PredictedType')
BEGIN
    CREATE INDEX IX_WasteReports_PredictedType ON dbo.WasteReports(PredictedWasteType);
END
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_PickupRequests_Municipality')
BEGIN
    CREATE INDEX IX_PickupRequests_Municipality ON dbo.PickupRequests(MunicipalityId);
END
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_AIPredictions_ReportId')
BEGIN
    CREATE INDEX IX_AIPredictions_ReportId ON dbo.AI_Predictions(ReportId);
END
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_AI_FeatureStore_RelatedEntity')
BEGIN
    CREATE INDEX IX_AI_FeatureStore_RelatedEntity ON dbo.AI_FeatureStore(RelatedEntity, RelatedEntityId);
END
IF NOT EXISTS (SELECT 1 FROM sys.indexes WHERE name = 'IX_MediaFiles_Entity')
BEGIN
    CREATE INDEX IX_MediaFiles_Entity ON dbo.MediaFiles(EntityType, EntityId);
END

-------------------------------------------------------------------
-- 10) Sample stored proc to set session context for RLS (to be called by app after connection)
-------------------------------------------------------------------
IF NOT EXISTS (SELECT 1 FROM sys.procedures WHERE name = 'sp_SetSessionUserContext')
BEGIN
EXEC('
CREATE PROCEDURE sp_SetSessionUserContext
    @AppUserId NVARCHAR(50),
    @AppRoles NVARCHAR(500)
AS
BEGIN
    -- set application user and roles for RLS
    EXEC sp_set_session_context ''app_user'', @AppUserId;
    EXEC sp_set_session_context ''app_roles'', @AppRoles;
END
');
END

-------------------------------------------------------------------
-- 12) Sample data safety: ensure existing triggers/procs referencing columns continue to work
-- (We didn't drop or rename existing columns   all additions are additive)
-------------------------------------------------------------------

PRINT 'Phase 2 enhancement script executed. Review messages above for any warnings.';
GO

-- Cleanup helper procedure (optionally drop) - keep it for re-runs
-- To drop helper (uncomment if desired)
-- DROP PROCEDURE dbo.__AddColumnIfNotExists;

-- ========================================
-- 9. SEED DATA (SEED FILE)
-- ========================================
---

## 🌍 PROJECT OVERVIEW

**Project Name:** SoorGreen (Somali for “Recycle / Grow Green”)
**Codename:** **DIBUCELIN** (“Rebirth” — symbolic of turning waste into value)
**Goal:** Build a smart eco-recycling and waste incentive system that connects citizens, collectors, and municipalities. Users earn digital credits for responsible disposal, redeemable for real rewards.

**Solution Layout:**
You will use **ONE Visual Studio solution** with **three major projects** to show diversity and skill.

---

## 🧩 PROJECT STRUCTURE (Solution View)

```
SoorGreen.sln
│
├── SoorGreen.Web/          → ASP.NET Core MVC (Public User Portal)
├── SoorGreen.Admin/        → ASP.NET WebForms (Admin & Municipality Panel)
├── SoorGreen.API/          → ASP.NET Web API (Mobile + Web shared logic)
└── SoorGreen.Data/         → Class Library (Database models, EF, helpers)
```

---

## ⚙️ TECHNOLOGY STACK

| Layer    | Framework / Tool                      | Purpose                                       |
| -------- | ------------------------------------- | --------------------------------------------- |
| Frontend | ASP.NET Core MVC, Razor, Tailwind CSS | Modern responsive UI                          |
| Admin    | ASP.NET WebForms                      | Classic data management & reports             |
| API      | ASP.NET Web API 2                     | Handles AJAX & mobile app integration         |
| Database | SQL Server 2019+                      | Central relational database                   |
| ORM      | Entity Framework Core                 | Model-DB mapping                              |
| Auth     | ASP.NET Identity + JWT                | User authentication                           |
| Extra    | SignalR                               | Real-time notifications for collectors/admins |
| Reports  | Crystal Reports (optional)            | Export waste reports, pickup stats            |
| Logging  | NLog                                  | Log files for system monitoring               |

---

## 🧱 DATABASE (SoorGreenDB)

Already defined in your script ✅
Add two small refinements:

### 1. **PickupVerifications**

Handles post-collection verification.

```sql
CREATE TABLE PickupVerifications (
    VerificationId CHAR(4) PRIMARY KEY,
    PickupId CHAR(4) NOT NULL,
    VerifiedKg DECIMAL(6,2) NOT NULL,
    MaterialType NVARCHAR(50),
    VerificationMethod NVARCHAR(50),
    VerifiedAt DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_Verifications_Pickup FOREIGN KEY(PickupId) REFERENCES PickupRequests(PickupId)
);
```

### 2. **SystemSettings**

Controls app configuration dynamically.

```sql
CREATE TABLE SystemSettings (
    SettingKey NVARCHAR(50) PRIMARY KEY,
    SettingValue NVARCHAR(200),
    UpdatedAt DATETIME DEFAULT GETDATE()
);
```

---

## 📦 ENTITY STRUCTURE (Data Project)

**Namespace:** `SoorGreen.Data.Entities`

```plaintext
Entities/
├── User.cs
├── Role.cs
├── Municipality.cs
├── WasteType.cs
├── WasteReport.cs
├── PickupRequest.cs
├── RewardPoint.cs
├── RedemptionRequest.cs
├── Notification.cs
├── AuditLog.cs
├── Feedback.cs
├── PickupVerification.cs
└── SystemSetting.cs
```

Each entity maps directly to your SQL schema with `DataAnnotations` attributes for validation.

---

## 🧩 API PROJECT (SoorGreen.API)

**Namespace:** `SoorGreen.API`
Used by both the Web MVC and mobile app later.

### Controllers

```plaintext
Controllers/
├── AuthController.cs
├── WasteController.cs
├── PickupController.cs
├── RewardsController.cs
├── FeedbackController.cs
└── NotificationsController.cs
```

### Routes Example

| Endpoint              | Method | Description         |
| --------------------- | ------ | ------------------- |
| `/api/auth/login`     | POST   | Authenticate user   |
| `/api/waste/report`   | POST   | Submit waste report |
| `/api/pickup/assign`  | PUT    | Assign collector    |
| `/api/reward/history` | GET    | User reward history |
| `/api/notifications`  | GET    | Fetch notifications |

---

## 🎨 MVC PROJECT (SoorGreen.Web)

**Namespace:** `SoorGreen.Web`
Used for citizens and public-facing features.

**Key Pages:**

| Controller           | View                     | Description                 |
| -------------------- | ------------------------ | --------------------------- |
| `HomeController`     | Index, About, Contact    | Public landing pages        |
| `AccountController`  | Login, Register, Profile | User authentication         |
| `WasteController`    | Report, History          | Submit & view waste reports |
| `PickupController`   | Track, Schedule          | Citizen pickup management   |
| `RewardsController`  | Dashboard, Redeem        | Reward points & redeem      |
| `FeedbackController` | Submit                   | Citizen suggestions         |

---

### 🧭 Folder Breakdown

```
wwwroot/
│── css/ (Tailwind build)
│── js/
│   ├── waste.js (AJAX forms)
│   ├── pickup.js (map tracking)
│   ├── rewards.js (animations)
│── libs/ (bootstrap, leaflet, toastr)
│── images/ (icons, banners)
```

**_Layout.cshtml** includes navbar, dark mode toggle, notification bell with SignalR real-time feed.

---

## 🖥️ ADMIN PROJECT (SoorGreen.Admin)

**Namespace:** `SoorGreen.Admin`
Tech: WebForms (.aspx)

### Pages:

| Page                | Description                             |
| ------------------- | --------------------------------------- |
| `Dashboard.aspx`    | Summary of reports, credits, collectors |
| `Users.aspx`        | Manage citizens, collectors             |
| `Pickups.aspx`      | Assign collectors, track progress       |
| `WasteReports.aspx` | View pending & verified reports         |
| `Rewards.aspx`      | Manage reward point logs                |
| `Reports.aspx`      | Generate monthly performance reports    |
| `Settings.aspx`     | Change credit rates, XP system          |
| `Login.aspx`        | Admin login                             |

### Admin Controls

| File                     | Purpose                     |
| ------------------------ | --------------------------- |
| `NavBar.ascx`            | Top menu                    |
| `Sidebar.ascx`           | Collapsible side navigation |
| `NotificationPanel.ascx` | Real-time activity panel    |

---

## 📡 SYSTEM INTERACTION FLOW

**Data Path Example:**
Citizen (MVC) → API → SoorGreenDB → Admin Dashboard → Reward Points Sync

1. User submits waste report via `WasteController` → API → `sp_AddWasteReport`.
2. Collector gets notification via SignalR.
3. Collector completes pickup → triggers `sp_CompletePickup`.
4. Credits added → Notification → User Reward Dashboard updates in real-time.

---

## 💰 REVENUE MODEL

| Source                 | Description                                       |
| ---------------------- | ------------------------------------------------- |
| **Corporate Sponsors** | Companies fund recycling drives for branding.     |
| **Waste Partnerships** | Recycling companies pay per verified pickup data. |
| **Ad Spots**           | Optional green ads in app or printed receipts.    |
| **Premium Redemption** | 3–5% commission from cash-out vendors.            |

---

## 🌱 SPECIAL FEATURES TO IMPRESS THE TEACHER

1. **Gamified Recycling Dashboard** — XP bar, level badges (Citizen → Eco Hero).
2. **AI Suggestion Engine (Optional)** — Simple ML model recommending nearest recycling points.
3. **Map Visualization** — Leaflet.js map of reported waste.
4. **Real-time Stats** — SignalR dashboard showing live pickups.
5. **Offline Mode (Later)** — Queue reports if user offline, sync when online.

---

## 🗂️ DEPLOYMENT NAMING

| Component | Suggested Name    |
| --------- | ----------------- |
| Solution  | `SoorGreen`       |
| MVC App   | `SoorGreen.Web`   |
| Admin     | `SoorGreen.Admin` |
| API       | `SoorGreen.API`   |
| Data      | `SoorGreen.Data`  |
| Database  | `SoorGreenDB`     |
| Codename  | `DIBUCELIN`       |

---

## 🧠 PRESENTATION IDEA (FOR TEACHER WOW FACTOR)

🎥 **Pitch as a Somali Smart Green Startup Initiative**
When presenting:

* Start by saying: *“Our mission is to turn waste into opportunity — every bottle recycled is a point earned and a cleaner city.”*
* Show real-time pickup dashboard (SignalR).
* End with: *“This is DIBUCELIN — rebirth through recycling.”*

---

If you want, I can now generate:

1. ✅ Full **Entity Framework models (C#)** for your tables
2. ✅ Or the **Visual Studio project template folder tree** with pre-named `.cs`, `.aspx`, `.cshtml`, and `.js` files ready for setup

Which one should we do next — **EF models** or **project template folders**?

using System;
using System.Data;
using System.Data.SqlClient;
using System.Collections.Generic;
using System.Web.Configuration;
using System.Web.UI;
using System.Web.Script.Serialization;
using System.Threading.Tasks;
using System.Linq;
using System.Diagnostics;

namespace SoorGreen.Citizen
{
    public partial class Community : System.Web.UI.Page
    {
        private string connectionString = WebConfigurationManager.ConnectionStrings["SoorGreenDBConnectionString"].ConnectionString;
        private string userId = string.Empty;
        private string userRole = string.Empty;
        private string userFullName = string.Empty;

        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                if (!ValidateUserSession())
                    return;

                Debug.WriteLine("=== COMMUNITY PAGE LOAD ===");
                Debug.WriteLine("UserID: " + userId);
                Debug.WriteLine("UserRole: " + userRole);
                Debug.WriteLine("FullName: " + userFullName);

                // Load all data
                LoadData();
            }
        }

        protected void btnLoadData_Click(object sender, EventArgs e)
        {
            LoadData();
        }

        protected void btnCreatePost_Click(object sender, EventArgs e)
        {
            string postContent = txtPostContent.Text.Trim();

            Debug.WriteLine("=== CREATING POST ===");
            Debug.WriteLine("User: " + userFullName);
            Debug.WriteLine("Content length: " + postContent.Length);

            if (!ValidatePostContent(postContent))
                return;

            if (CreatePost(postContent))
            {
                ShowNotification("Post created successfully!", "success");
                txtPostContent.Text = "";
                // Refresh data
                LoadData();
            }
            else
            {
                ShowNotification("Error creating post. Please try again.", "error");
            }
        }

        protected void LoadData()
        {
            try
            {
                Debug.WriteLine("=== LOAD DATA START ===");

                // Load all data
                LoadPostsData();
                LoadStatsData();
                LoadOnlineUsersData();
                LoadEventsData();

                Debug.WriteLine("=== LOAD DATA COMPLETE ===");
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error in LoadData: " + ex.Message);
                Debug.WriteLine("Stack trace: " + ex.StackTrace);
                SetDefaultData();
            }
        }

        private void LoadPostsData()
        {
            try
            {
                var posts = LoadCommunityPosts();
                hfPostsData.Value = DataTableToJson(posts);
                Debug.WriteLine("Posts loaded: " + posts.Rows.Count);
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error loading posts: " + ex.Message);
                hfPostsData.Value = "[]";
            }
        }

        private void LoadStatsData()
        {
            try
            {
                var stats = new
                {
                    TotalMembers = GetTotalMembers(),
                    ActiveNow = GetActiveUsersCount(),
                    PostsToday = GetPostsTodayCount(),
                    EventsThisWeek = GetEventsThisWeekCount(),
                    TotalPosts = GetTotalPosts(),
                    EngagementRate = GetEngagementRate()
                };

                var serializer = new JavaScriptSerializer();
                hfStatsData.Value = serializer.Serialize(stats);
                Debug.WriteLine("Stats loaded: " + hfStatsData.Value);
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error loading stats: " + ex.Message);
                hfStatsData.Value = "{\"TotalMembers\":0,\"ActiveNow\":0,\"PostsToday\":0,\"EventsThisWeek\":0,\"TotalPosts\":0,\"EngagementRate\":0}";
            }
        }

        private void LoadOnlineUsersData()
        {
            try
            {
                var onlineUsers = LoadOnlineUsers();
                var serializer = new JavaScriptSerializer();
                hfOnlineUsers.Value = serializer.Serialize(onlineUsers);
                Debug.WriteLine("Online users loaded: " + onlineUsers.Count);
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error loading online users: " + ex.Message);
                hfOnlineUsers.Value = "[]";
            }
        }

        private void LoadEventsData()
        {
            try
            {
                var events = LoadCommunityEvents();
                var serializer = new JavaScriptSerializer();
                hfEvents.Value = serializer.Serialize(events);
                Debug.WriteLine("Events loaded: " + events.Count);
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error loading events: " + ex.Message);
                hfEvents.Value = "[]";
            }
        }

        private DataTable LoadCommunityPosts()
        {
            DataTable dt = new DataTable();

            try
            {
                Debug.WriteLine("=== LOADING COMMUNITY POSTS ===");

                // FIXED QUERY - Using your actual schema
                string query = @"
                    SELECT 
                        ua.ActivityId as PostId,
                        ua.UserId,
                        u.FullName,
                        u.ProfilePicture,
                        ua.Description as Content,
                        ua.ActivityType as PostType,
                        ua.Timestamp as CreatedAt,
                        u.XP_Credits as UserXP
                    FROM UserActivities ua
                    INNER JOIN Users u ON ua.UserId = u.UserId
                    WHERE ua.ActivityType IN ('CommunityPost', 'Achievement', 'Tip', 'Question', 'Event')
                    ORDER BY ua.Timestamp DESC";

                using (SqlConnection conn = new SqlConnection(connectionString))
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    conn.Open();

                    using (SqlDataAdapter adapter = new SqlDataAdapter(cmd))
                    {
                        adapter.Fill(dt);
                    }
                }

                Debug.WriteLine("Posts loaded from DB: " + dt.Rows.Count);

                // Add computed columns for display (these don't exist in DB, we calculate them)
                dt.Columns.Add("UserName", typeof(string));
                dt.Columns.Add("UserAvatar", typeof(string));
                dt.Columns.Add("UserTitle", typeof(string));
                dt.Columns.Add("UserLevel", typeof(int));
                dt.Columns.Add("TimeAgo", typeof(string));
                dt.Columns.Add("Likes", typeof(int));
                dt.Columns.Add("Comments", typeof(int));
                dt.Columns.Add("Shares", typeof(int));
                dt.Columns.Add("IsLiked", typeof(bool));
                dt.Columns.Add("IsPinned", typeof(bool));

                foreach (DataRow row in dt.Rows)
                {
                    string fullName = row["FullName"] != DBNull.Value ? row["FullName"].ToString() : "Community Member";
                    string profilePicture = row["ProfilePicture"] != DBNull.Value ? row["ProfilePicture"].ToString() : "";
                    DateTime createdAt = row["CreatedAt"] != DBNull.Value ? Convert.ToDateTime(row["CreatedAt"]) : DateTime.Now;
                    decimal userXP = row["UserXP"] != DBNull.Value ? Convert.ToDecimal(row["UserXP"]) : 0;

                    row["UserName"] = FormatUserName(fullName);
                    row["UserAvatar"] = string.IsNullOrEmpty(profilePicture) ? GetUserInitials(fullName) : profilePicture;
                    row["UserTitle"] = GetUserTitle(userXP);
                    row["UserLevel"] = CalculateUserLevel(userXP);
                    row["TimeAgo"] = GetTimeAgo(createdAt);

                    // Default values for columns that don't exist in DB
                    row["Likes"] = 0;
                    row["Comments"] = 0;
                    row["Shares"] = 0;
                    row["IsLiked"] = false;
                    row["IsPinned"] = false;

                    Debug.WriteLine("Processed post: " + row["UserName"] + " - " + row["TimeAgo"] + ": " + (row["Content"].ToString().Length > 50 ? row["Content"].ToString().Substring(0, 50) + "..." : row["Content"]));
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error loading community posts: " + ex.Message);
                Debug.WriteLine("Stack trace: " + ex.StackTrace);
                CreateEmptyPostsTable(dt);
            }

            return dt;
        }

        private bool CreatePost(string content)
        {
            try
            {
                Debug.WriteLine("Creating post for user: " + userId);

                string query = @"
                    INSERT INTO UserActivities 
                    (UserId, ActivityType, Description, Timestamp)
                    VALUES 
                    (@UserId, 'CommunityPost', @Content, GETDATE());
                    
                    UPDATE Users 
                    SET XP_Credits = ISNULL(XP_Credits, 0) + 5
                    WHERE UserId = @UserId;";

                using (SqlConnection conn = new SqlConnection(connectionString))
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@UserId", userId);
                    cmd.Parameters.AddWithValue("@Content", content);

                    conn.Open();
                    int result = cmd.ExecuteNonQuery();

                    Debug.WriteLine("Post creation result: " + result);
                    return result > 0;
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error creating post: " + ex.Message);
                Debug.WriteLine("Stack trace: " + ex.StackTrace);
                return false;
            }
        }

        private List<OnlineUser> LoadOnlineUsers()
        {
            var onlineUsers = new List<OnlineUser>();

            try
            {
                // FIXED QUERY - Removed ISNULL(u.IsActive, 1) = 1 since IsActive doesn't exist in your schema
                string query = @"
                    SELECT TOP 8 
                        u.UserId,
                        u.FullName,
                        u.ProfilePicture,
                        u.LastLogin,
                        u.XP_Credits,
                        DATEDIFF(MINUTE, u.LastLogin, GETDATE()) as MinutesSinceLogin
                    FROM Users u
                    WHERE u.RoleId IN ('CITZ', 'R001')
                    AND u.LastLogin IS NOT NULL
                    ORDER BY u.LastLogin DESC";

                using (SqlConnection conn = new SqlConnection(connectionString))
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    conn.Open();
                    using (SqlDataReader reader = cmd.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            string fullName = reader["FullName"] != DBNull.Value ? reader["FullName"].ToString() : "User";
                            string profilePicture = reader["ProfilePicture"] != DBNull.Value ? reader["ProfilePicture"].ToString() : "";
                            int minutesSinceLogin = reader["MinutesSinceLogin"] != DBNull.Value ? Convert.ToInt32(reader["MinutesSinceLogin"]) : 0;
                            decimal xpCredits = reader["XP_Credits"] != DBNull.Value ? Convert.ToDecimal(reader["XP_Credits"]) : 0;

                            string status = GetOnlineStatus(minutesSinceLogin);
                            string avatar = string.IsNullOrEmpty(profilePicture) ? GetUserInitials(fullName) : profilePicture;

                            var user = new OnlineUser
                            {
                                UserId = reader["UserId"] != DBNull.Value ? reader["UserId"].ToString() : "",
                                Name = FormatUserName(fullName),
                                Avatar = avatar,
                                Status = status,
                                XP = xpCredits,
                                Level = CalculateUserLevel(xpCredits),
                                IsActive = minutesSinceLogin <= 15
                            };

                            onlineUsers.Add(user);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error loading online users: " + ex.Message);
            }

            return onlineUsers;
        }

        private List<CommunityEvent> LoadCommunityEvents()
        {
            var events = new List<CommunityEvent>();

            try
            {
                // FIXED QUERY - Check if CommunityEvents table exists first
                string checkTableQuery = "SELECT CASE WHEN OBJECT_ID('CommunityEvents', 'U') IS NOT NULL THEN 1 ELSE 0 END";
                bool tableExists = false;

                using (SqlConnection conn = new SqlConnection(connectionString))
                using (SqlCommand cmd = new SqlCommand(checkTableQuery, conn))
                {
                    conn.Open();
                    tableExists = Convert.ToInt32(cmd.ExecuteScalar()) == 1;
                }

                if (tableExists)
                {
                    string query = @"
                        SELECT TOP 5 
                            EventId,
                            Title,
                            Description,
                            EventDate,
                            Location,
                            OrganizerId,
                            EventType,
                            ISNULL(MaxParticipants, 0) as MaxParticipants,
                            ISNULL(CurrentParticipants, 0) as CurrentParticipants
                        FROM CommunityEvents 
                        WHERE EventDate >= GETDATE()
                        ORDER BY EventDate ASC";

                    using (SqlConnection conn = new SqlConnection(connectionString))
                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        conn.Open();
                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                var eventItem = new CommunityEvent
                                {
                                    EventId = reader["EventId"] != DBNull.Value ? reader["EventId"].ToString() : Guid.NewGuid().ToString(),
                                    Title = reader["Title"] != DBNull.Value ? reader["Title"].ToString() : "Community Event",
                                    Description = reader["Description"] != DBNull.Value ? reader["Description"].ToString() : "Join us for this exciting event!",
                                    Date = reader["EventDate"] != DBNull.Value ? FormatEventDate(Convert.ToDateTime(reader["EventDate"])) : "Coming Soon",
                                    Location = reader["Location"] != DBNull.Value ? reader["Location"].ToString() : "Online",
                                    EventType = reader["EventType"] != DBNull.Value ? reader["EventType"].ToString() : "General",
                                    Participants = reader["CurrentParticipants"] != DBNull.Value ? Convert.ToInt32(reader["CurrentParticipants"]) : 0,
                                    MaxParticipants = reader["MaxParticipants"] != DBNull.Value ? Convert.ToInt32(reader["MaxParticipants"]) : 0
                                };
                                events.Add(eventItem);
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error loading events: " + ex.Message);
            }

            return events;
        }

        private bool ValidateUserSession()
        {
            if (Session["UserId"] == null || Session["UserRole"] == null)
            {
                Response.Redirect("~/Login.aspx");
                return false;
            }

            userId = Session["UserId"].ToString();
            userRole = Session["UserRole"].ToString();
            userFullName = Session["FullName"] != null ? Session["FullName"].ToString() : "User";

            if (userRole != "CITZ" && userRole != "R001")
            {
                Response.Redirect("~/Pages/Unauthorized.aspx");
                return false;
            }

            return true;
        }

        private bool ValidatePostContent(string content)
        {
            if (string.IsNullOrWhiteSpace(content))
            {
                ShowNotification("Please write something to post!", "error");
                return false;
            }

            if (content.Length > 500)
            {
                ShowNotification("Post is too long! Maximum 500 characters.", "error");
                return false;
            }

            return true;
        }

        private string FormatUserName(string fullName)
        {
            if (string.IsNullOrWhiteSpace(fullName))
                return "Community Member";

            var parts = fullName.Split(' ');
            return parts.Length > 0 ? parts[0] : fullName;
        }

        private string GetUserInitials(string fullName)
        {
            if (string.IsNullOrWhiteSpace(fullName))
                return "CM";

            var parts = fullName.Split(new char[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length >= 2)
                return (parts[0][0].ToString() + parts[1][0].ToString()).ToUpper();
            else if (fullName.Length >= 2)
                return fullName.Substring(0, 2).ToUpper();
            else
                return fullName.ToUpper();
        }

        private string GetUserTitle(decimal xpCredits)
        {
            if (xpCredits >= 1000) return "Eco Champion";
            if (xpCredits >= 500) return "Green Warrior";
            if (xpCredits >= 200) return "Sustainability Expert";
            if (xpCredits >= 100) return "Eco Enthusiast";
            return "Eco Beginner";
        }

        private int CalculateUserLevel(decimal xpCredits)
        {
            return (int)Math.Floor(xpCredits / 100) + 1;
        }

        private string GetTimeAgo(DateTime date)
        {
            var timeSpan = DateTime.Now - date;

            if (timeSpan.TotalMinutes < 1)
                return "Just now";
            else if (timeSpan.TotalMinutes < 60)
                return ((int)timeSpan.TotalMinutes).ToString() + "m ago";
            else if (timeSpan.TotalHours < 24)
                return ((int)timeSpan.TotalHours).ToString() + "h ago";
            else if (timeSpan.TotalDays < 7)
                return ((int)timeSpan.TotalDays).ToString() + "d ago";
            else if (timeSpan.TotalDays < 30)
                return (((int)timeSpan.TotalDays / 7).ToString()) + "w ago";
            else
                return date.ToString("MMM dd, yyyy");
        }

        private string GetOnlineStatus(int minutesSinceLogin)
        {
            if (minutesSinceLogin <= 5)
                return "Online now";
            else if (minutesSinceLogin <= 15)
                return "Active recently";
            else if (minutesSinceLogin <= 60)
                return "Away";
            else
                return "Offline";
        }

        private string FormatEventDate(DateTime eventDate)
        {
            if (eventDate.Date == DateTime.Today)
                return "Today, " + eventDate.ToString("h:mm tt");
            else if (eventDate.Date == DateTime.Today.AddDays(1))
                return "Tomorrow, " + eventDate.ToString("h:mm tt");
            else if (eventDate.Date <= DateTime.Today.AddDays(7))
                return eventDate.ToString("ddd, h:mm tt");
            else
                return eventDate.ToString("MMM dd, h:mm tt");
        }

        private int GetTotalMembers()
        {
            try
            {
                // FIXED QUERY - Removed IsActive check
                string query = "SELECT COUNT(*) FROM Users WHERE RoleId IN ('CITZ', 'R001')";
                return GetScalarValue(query);
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error getting total members: " + ex.Message);
                return 0;
            }
        }

        private int GetActiveUsersCount()
        {
            try
            {
                // FIXED QUERY - Removed IsActive check
                string query = "SELECT COUNT(*) FROM Users WHERE LastLogin >= DATEADD(HOUR, -1, GETDATE()) AND RoleId IN ('CITZ', 'R001')";
                return GetScalarValue(query);
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error getting active users: " + ex.Message);
                return 0;
            }
        }

        private int GetPostsTodayCount()
        {
            try
            {
                // FIXED QUERY - Removed IsActive check
                string query = "SELECT COUNT(*) FROM UserActivities WHERE ActivityType = 'CommunityPost' AND CAST(Timestamp AS DATE) = CAST(GETDATE() AS DATE)";
                return GetScalarValue(query);
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error getting posts today: " + ex.Message);
                return 0;
            }
        }

        private int GetEventsThisWeekCount()
        {
            try
            {
                string query = "SELECT COUNT(*) FROM CommunityEvents WHERE EventDate >= CAST(GETDATE() AS DATE) AND EventDate <= DATEADD(DAY, 7, CAST(GETDATE() AS DATE))";
                return GetScalarValue(query);
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error getting events count: " + ex.Message);
                return 0;
            }
        }

        private int GetTotalPosts()
        {
            try
            {
                // FIXED QUERY - Removed IsActive check
                string query = "SELECT COUNT(*) FROM UserActivities WHERE ActivityType = 'CommunityPost'";
                return GetScalarValue(query);
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error getting total posts: " + ex.Message);
                return 0;
            }
        }

        private decimal GetEngagementRate()
        {
            try
            {
                // Since Likes/Comments/Shares columns don't exist, return 0
                return 0;
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Error getting engagement rate: " + ex.Message);
                return 0;
            }
        }

        private int GetScalarValue(string query)
        {
            try
            {
                using (SqlConnection conn = new SqlConnection(connectionString))
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    conn.Open();
                    var result = cmd.ExecuteScalar();
                    return result != DBNull.Value ? Convert.ToInt32(result) : 0;
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Scalar query error: " + ex.Message);
                return 0;
            }
        }

        private string DataTableToJson(DataTable dt)
        {
            try
            {
                var rows = new List<Dictionary<string, object>>();

                foreach (DataRow dr in dt.Rows)
                {
                    var row = new Dictionary<string, object>();
                    foreach (DataColumn col in dt.Columns)
                    {
                        object val = dr[col];
                        if (val == DBNull.Value)
                            val = null;
                        row.Add(col.ColumnName, val);
                    }
                    rows.Add(row);
                }
                return new JavaScriptSerializer().Serialize(rows);
            }
            catch (Exception ex)
            {
                Debug.WriteLine("JSON serialization error: " + ex.Message);
                return "[]";
            }
        }

        private void CreateEmptyPostsTable(DataTable dt)
        {
            dt.Columns.Clear();
            dt.Columns.Add("PostId", typeof(string));
            dt.Columns.Add("UserId", typeof(string));
            dt.Columns.Add("FullName", typeof(string));
            dt.Columns.Add("Content", typeof(string));
            dt.Columns.Add("PostType", typeof(string));
            dt.Columns.Add("CreatedAt", typeof(DateTime));
            dt.Columns.Add("Likes", typeof(int));
            dt.Columns.Add("Comments", typeof(int));
            dt.Columns.Add("Shares", typeof(int));
            dt.Columns.Add("IsLiked", typeof(bool));
            dt.Columns.Add("UserName", typeof(string));
            dt.Columns.Add("UserAvatar", typeof(string));
            dt.Columns.Add("UserTitle", typeof(string));
            dt.Columns.Add("UserLevel", typeof(int));
            dt.Columns.Add("TimeAgo", typeof(string));
            dt.Columns.Add("IsPinned", typeof(bool));
        }

        private void SetDefaultData()
        {
            hfPostsData.Value = "[]";
            hfStatsData.Value = "{\"TotalMembers\":0,\"ActiveNow\":0,\"PostsToday\":0,\"EventsThisWeek\":0,\"TotalPosts\":0,\"EngagementRate\":0}";
            hfOnlineUsers.Value = "[]";
            hfEvents.Value = "[]";
        }

        private void ShowNotification(string message, string type)
        {
            string script = string.Format(@"
                <script>
                    setTimeout(function() {{
                        alert('{0}');
                    }}, 300);
                </script>",
                message.Replace("'", "\\'"));

            ClientScript.RegisterStartupScript(this.GetType(), "ShowNotification", script, false);
        }
    }

    public class OnlineUser
    {
        public string UserId { get; set; }
        public string Name { get; set; }
        public string Avatar { get; set; }
        public string Status { get; set; }
        public decimal XP { get; set; }
        public int Level { get; set; }
        public bool IsActive { get; set; }
    }

    public class CommunityEvent
    {
        public string EventId { get; set; }
        public string Title { get; set; }
        public string Description { get; set; }
        public string Date { get; set; }
        public string Location { get; set; }
        public string EventType { get; set; }
        public int Participants { get; set; }
        public int MaxParticipants { get; set; }
    }
}